{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="page-inner">
  <h4 class="page-title">FireApp Dashboard</h4>
  <div class="page-category">
    Fire incident visualization dashboard. 
    <a href="https://www.chartjs.org/" target="_blank">Chart.js documentation</a>.
  </div>
  
  <!-- Loading Indicator -->
  <div id="loadingIndicator" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="sr-only">Loading...</span>
    </div>
    <p>Loading dashboard data...</p>
  </div>

  <div class="row" id="chartsContainer" style="display: none;">
    <!-- Line Chart - Monthly Trends -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Monthly Incident Trends</div>
        </div>
        <div class="card-body">
          <div class="chart-container">
            <canvas id="lineChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Pie Chart - Incident Types -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Incident Types</div>
        </div>
        <div class="card-body">
          <div class="chart-container">
            <canvas id="pieChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Bar Chart - Severity Distribution -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Severity Distribution</div>
        </div>
        <div class="card-body">
          <div class="chart-container">
            <canvas id="barChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Doughnut Chart - Status Breakdown -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Status Breakdown</div>
        </div>
        <div class="card-body">
          <div class="chart-container">
            <canvas id="doughnutChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Multi-line Chart - Top Locations -->
    <div class="col-md-12">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Top Locations - Monthly Comparison</div>
        </div>
        <div class="card-body">
          <div class="chart-container">
            <canvas id="multiLineChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block chart %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Show loading indicator
  const loadingIndicator = document.getElementById('loadingIndicator');
  const chartsContainer = document.getElementById('chartsContainer');
  
  // Chart color scheme
  const chartColors = {
    blue: '#1d7af3',
    red: '#f3545d',
    yellow: '#fdaf4b',
    green: '#59d05d',
    purple: '#716aca',
    teal: '#17ead9'
  };

  // Fetch data and initialize charts
  Promise.all([
    fetchChartData('/api/charts/severity-pie/'),
    fetchChartData('/api/charts/monthly-line/'),
    fetchChartData('/api/charts/severity-bar/'),
    fetchChartData('/api/charts/top-locations/')
  ])
  .then(([pieData, lineData, barData, multiLineData]) => {
    // Hide loading indicator
    loadingIndicator.style.display = 'none';
    chartsContainer.style.display = 'block';
    
    // Initialize charts
    initPieChart(pieData);
    initLineChart(lineData);
    initBarChart(barData);
    initMultiLineChart(multiLineData);
    
  })
  .catch(error => {
    console.error('Error loading dashboard data:', error);
    loadingIndicator.innerHTML = `
      <div class="alert alert-danger">
        Failed to load dashboard data. Please try again later.
      </div>
    `;
  });

  // Generic data fetcher
  function fetchChartData(url) {
    return fetch(url)
      .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
      });
  }

  // Pie Chart - Incident Types
  function initPieChart(data) {
    const ctx = document.getElementById('pieChart').getContext('2d');
    
    if (!data || Object.keys(data).length === 0) {
      document.getElementById('pieChart').closest('.card-body').innerHTML = `
        <div class="alert alert-info">No incident type data available</div>
      `;
      return;
    }

    new Chart(ctx, {
      type: 'pie',
      data: {
        labels: Object.keys(data),
        datasets: [{
          data: Object.values(data),
          backgroundColor: [
            chartColors.blue, 
            chartColors.red, 
            chartColors.yellow,
            chartColors.green,
            chartColors.purple
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              padding: 20,
              usePointStyle: true
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const value = context.raw;
                const percentage = Math.round((value / total) * 100);
                return `${context.label}: ${value} (${percentage}%)`;
              }
            }
          }
        }
      }
    });
  }

  // Line Chart - Monthly Trends
  function initLineChart(data) {
    const ctx = document.getElementById('lineChart').getContext('2d');
    
    if (!data || Object.keys(data).length === 0) {
      document.getElementById('lineChart').closest('.card-body').innerHTML = `
        <div class="alert alert-info">No monthly trend data available</div>
      `;
      return;
    }

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: Object.keys(data),
        datasets: [{
          label: 'Incidents',
          data: Object.values(data),
          borderColor: chartColors.blue,
          backgroundColor: 'rgba(29, 122, 243, 0.1)',
          borderWidth: 2,
          pointBackgroundColor: '#fff',
          pointBorderColor: chartColors.blue,
          pointBorderWidth: 2,
          pointRadius: 4,
          pointHoverRadius: 6,
          fill: true,
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              drawBorder: false
            }
          },
          x: {
            grid: {
              display: false
            }
          }
        },
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            mode: 'index',
            intersect: false
          }
        }
      }
    });
  }

  // Bar Chart - Severity Distribution
  function initBarChart(data) {
    const ctx = document.getElementById('barChart').getContext('2d');
    
    if (!data || Object.keys(data).length === 0) {
      document.getElementById('barChart').closest('.card-body').innerHTML = `
        <div class="alert alert-info">No severity data available</div>
      `;
      return;
    }

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Object.keys(data),
        datasets: [{
          label: 'Incidents by Severity',
          data: Object.values(data),
          backgroundColor: [
            chartColors.green,
            chartColors.yellow,
            chartColors.red
          ],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              drawBorder: false
            }
          },
          x: {
            grid: {
              display: false
            }
          }
        },
        plugins: {
          legend: {
            display: false
          }
        }
      }
    });
  }

  // Multi-line Chart - Top Locations
  function initMultiLineChart(data) {
    const ctx = document.getElementById('multiLineChart').getContext('2d');
    
    if (!data || Object.keys(data).length === 0) {
      document.getElementById('multiLineChart').closest('.card-body').innerHTML = `
        <div class="alert alert-info">No location comparison data available</div>
      `;
      return;
    }

    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                      'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const colors = [chartColors.blue, chartColors.red, chartColors.purple];
    
    const datasets = Object.keys(data).map((location, index) => ({
      label: location,
      data: monthNames.map(month => data[location][month] || 0),
      borderColor: colors[index % colors.length],
      backgroundColor: 'transparent',
      borderWidth: 2,
      pointBackgroundColor: '#fff',
      pointBorderColor: colors[index % colors.length],
      pointBorderWidth: 2,
      pointRadius: 3,
      pointHoverRadius: 5,
      tension: 0.1
    }));

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: monthNames,
        datasets: datasets
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              drawBorder: false
            }
          },
          x: {
            grid: {
              display: false
            }
          }
        },
        plugins: {
          legend: {
            position: 'top',
            labels: {
              padding: 20,
              usePointStyle: true
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return `${context.dataset.label}: ${context.raw}`;
              }
            }
          }
        }
      }
    });
  }
});
</script>
{% endblock %}